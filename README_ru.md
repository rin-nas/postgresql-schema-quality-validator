# ✅ Валидатор качества схемы БД PostgreSQL

## Цели

1. Автоматизация инспекций миграций (изменений) БД. 
1. Поддержание заданного уровня качества БД: скорости работы SQL запросов c целостностью данных и наличия документации.

## Применение

* Валидация схемы БД при ручном или автоматическом тестировании наката-отката миграций БД в CI/CD

## Описание работы

Валидатор представляет из себя функцию для БД PostgreSQL 12+.

Настройки хранятся в таблице `db_validation.schema_validate_config`. 

Запуск:

```sql
select db_validation.schema_validate();
```

Функция проверяет в текущей БД объекты БД (таблицы и др.) на наличие ошибок. Никаких данных не возвращается. 
Если проблемы не найдены, функция успешно завершает работу, иначе возвращается ошибка (исключение в терминах PL/PgSQL): текст ошибки и рекомендации по исправлению.

Можно запускать функцию в одной транзакции 2 раза: до и после выполнения миграций на тестовой БД.
Если до выполнения миграций ошибок нет, а после имеются, значит проблема в миграции БД.
Так же можно запускать функцию только по одному разу после наката и отката миграции.

## Проверки

### has_pk_uk

Наличие первичного или уникального индекса в таблице.

Первичный индекс (PK) позволяет:

* однозначно идентифицировать запись таблицы БД
* получить очень быстрый доступ к записи

Уникальный индекс (UK) позволяет исключить дубликаты. 
Без PK или UK невозможно сделать логическую репликацию.

### has_not_redundant_index

Отсутствие избыточных индексов в таблице.

Если есть составной индекс на поля col1 и col2 (именно в такой последовательности), то отдельный индекс на поле col1 не нужен, он избыточный. 
Лишние индексы занимают место на диске и замедляют DML запросы.

### has_index_for_fk

Наличие индексов для ограничений внешних ключей в таблице.

Без индексов на ограничения внешних ключей (FK) могут работать медленно элементарные запросы типа 
`DELETE FROM {table} WHERE id=<id>` из-за ссылающихся на `{table}` таблиц по FK без индекса. [Дополнительная информация](https://www.databasesoup.com/2014/11/finding-foreign-keys-with-no-indexes.html).

### has_table_comment

Наличие описания для таблицы.

На этапе проектирования описание помогает лучше понять назначение таблицы и на сколько удачно она названа исходя из описания. 
В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. 
Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается. 
Значение в `COMMENT ON TABLE {table}` не должно быть пустым и не должно совпадать с названием таблицы. 
Таблицы-секции из проверки исключаются. 

### has_column_comment

Наличие описания для колонки.

На этапе проектирования описание помогает лучше понять назначение колонки и на сколько удачно она названа исходя из описания. 
В дальнейшем тандем названия и описания упрощают понимание и поддержку кода. 
Порог входа для новых IT специалистов (разработчиков, тестировщиков, бизнес- и системных аналитиков) уменьшается. 
Значение в `COMMENT ON TABLE {table}.{column}` не должно быть пустым и не должно совпадать с названием колонки. 
Колонки с названием `id` из проверки исключаются. 
Таблицы-секции из проверки исключаются.

### has_not_varchar_columns

Отсутствие `char(n)` и `varchar(n)` колонок.

Используйте колонки с типом `text`. Скорость чтения-записи [не изменится](https://postgrespro.ru/docs/postgresql/14/datatype-character). 
Проверку на максимальную длину нужно сделать через ограничение CHECK. При этом лучше сразу задать ограничение на минимальную длину. Пример:

```sql
name text not null check(length(name) between 0 and 255)
```

Ошибка превышения длины поля и ошибка нарушения ограничения check — это разные ошибки с разным кодом.

Основное неудобство типов `char(n)` и `varchar(n)` — это изменение ограничения n для существующей колонки таблицы через `ALTER TABLE`.
* Изменение `n` в меньшую сторону происходит редко, но эта операция блокирует таблицу на чтение-запись. 
  Ещё это медленная операция, т.к. неявно валидируются все данные в колонке, чтобы длина текста не превышала `n`. 
  А после этого неявно перестраиваются все индексы, где используется эта колонка.
* Изменение `n` в большую сторону происходит чаще. Это неблокирующая операция, но индексы для колонки так же неявно перестраиваются и это опять блокирующая на запись операция.

См. так же [дополнительные аргументы](https://wiki.postgresql.org/wiki/Don%27t_Do_This#Text_storage).

### has_not_timestamp_columns

Отсутствие `timestamp` колонок.

Вместо устаревшего `TIMESTAMP` (WITHOUT TIME ZONE) используйте `TIMESTAMPTZ` (TIMESTAMP WITH TIME ZONE). 
Обоснование: [статья](https://habr.com/ru/articles/772954/) на Хабре, [дополнительные аргументы](https://wiki.postgresql.org/wiki/Don%27t_Do_This#Don.27t_use_timestamp_.28without_time_zone.29).

### valid_schema_name, valid_table_name, valid_table_column_name, valid_view_name, valid_view_column_name, valid_schema_name, valid_procedure_name, valid_function_name

Валидные названия
* схем
* таблиц
* колонок таблиц
* представлений
* колонок представлений
* триггеров
* процедур
* функций

Названия объектов БД должны
* содержать только английские буквы, цифры, дефис, тире.
* быть только в нижнем регистре (Postgres makes everything lower case unless you double quote it).

Это соответствует регулярному выражению `^[a-z][a-z\d_\-]*[a-z\d]$`, оно используется по умолчанию.

Для проверки названий в конфигурации имеются соответствующие параметры с регулярными выражениями для каждого объекта БД.

Были случаи, когда в названии колонки не заметили русскую букву `c` и это попало в производственную БД.
